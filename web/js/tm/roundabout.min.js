jQuery.extend({roundabout_shape:{def:"lazySusan",lazySusan:function(e,t,n){return{x:Math.sin(e+t),y:Math.sin(e+3*Math.PI/2+t)/8*n,z:(Math.cos(e+t)+1)/2,scale:Math.sin(e+Math.PI/2+t)/2+.5}}}}),jQuery.fn.roundabout=function(){var e="object"!=typeof arguments[0]?{}:arguments[0];if(e={bearing:e.bearing===void 0?0:jQuery.roundabout_toFloat(e.bearing%360),tilt:e.tilt===void 0?0:jQuery.roundabout_toFloat(e.tilt),minZ:e.minZ===void 0?100:parseInt(e.minZ,10),maxZ:e.maxZ===void 0?400:parseInt(e.maxZ,10),minScale:e.minScale===void 0?.4:jQuery.roundabout_toFloat(e.minScale),maxScale:e.maxScale===void 0?1:jQuery.roundabout_toFloat(e.maxScale),duration:e.duration===void 0?600:parseInt(e.duration,10),btnNext:e.btnNext||null,btnPrev:e.btnPrev||null,easing:e.easing||"swing",clickToFocus:e.clickToFocus!==!1,focusBearing:e.focusBearing===void 0?0:jQuery.roundabout_toFloat(e.focusBearing%360),shape:e.shape||"lazySusan",debug:e.debug||!1,childSelector:e.childSelector||"li",startingChild:e.startingChild===void 0?null:parseInt(e.startingChild,10),reflect:e.reflect===void 0||e.reflect===!1?!1:!0},this.each(function(){var t=jQuery(this),n=jQuery.roundabout_toFloat(360/t.children(e.childSelector).length),i=null===e.startingChild?e.bearing:e.startingChild*n;t.addClass("roundabout-holder").css("padding",0).css("position","relative").css("z-index",e.minZ),t.data("roundabout",{bearing:i,tilt:e.tilt,minZ:e.minZ,maxZ:e.maxZ,minScale:e.minScale,maxScale:e.maxScale,duration:e.duration,easing:e.easing,clickToFocus:e.clickToFocus,focusBearing:e.focusBearing,animating:0,childInFocus:-1,shape:e.shape,period:n,debug:e.debug,childSelector:e.childSelector,reflect:e.reflect}),e.clickToFocus===!0&&t.children(e.childSelector).each(function(i){jQuery(this).click(function(o){var a=e.reflect===!0?360-n*i:n*i;return a=jQuery.roundabout_toFloat(a),jQuery.roundabout_isInFocus(t,a)?void 0:(o.preventDefault(),0===t.data("roundabout").animating&&t.roundabout_animateAngleToFocus(a),!1)})}),e.btnNext&&jQuery(e.btnNext).bind("click.roundabout",function(e){return e.preventDefault(),0===t.data("roundabout").animating&&t.roundabout_animateToNextChild(),!1}),e.btnPrev&&jQuery(e.btnPrev).bind("click.roundabout",function(e){return e.preventDefault(),0===t.data("roundabout").animating&&t.roundabout_animateToPreviousChild(),!1})}),this.roundabout_startChildren(),"function"==typeof arguments[1]){var t=arguments[1],n=this;setTimeout(function(){t(n)},0)}return this},jQuery.fn.roundabout_startChildren=function(){return this.each(function(){var e=jQuery(this),t=e.data("roundabout"),n=e.children(t.childSelector);n.each(function(e){var n=t.reflect===!0?360-t.period*e:t.period*e;jQuery(this).addClass("roundabout-moveable-item").css("position","absolute"),jQuery(this).data("roundabout",{startWidth:jQuery(this).width(),startHeight:jQuery(this).height(),startFontSize:parseInt(jQuery(this).css("font-size"),10),degrees:n})}),e.roundabout_updateChildPositions()}),this},jQuery.fn.roundabout_setTilt=function(e){if(this.each(function(){jQuery(this).data("roundabout").tilt=e,jQuery(this).roundabout_updateChildPositions()}),"function"==typeof arguments[1]){var t=arguments[1],n=this;setTimeout(function(){t(n)},0)}return this},jQuery.fn.roundabout_setBearing=function(e){if(this.each(function(){jQuery(this).data("roundabout").bearing=jQuery.roundabout_toFloat(e%360,2),jQuery(this).roundabout_updateChildPositions()}),"function"==typeof arguments[1]){var t=arguments[1],n=this;setTimeout(function(){t(n)},0)}return this},jQuery.fn.roundabout_adjustBearing=function(e){if(e=jQuery.roundabout_toFloat(e),0!==e&&this.each(function(){jQuery(this).data("roundabout").bearing=jQuery.roundabout_getBearing(jQuery(this))+e,jQuery(this).roundabout_updateChildPositions()}),"function"==typeof arguments[1]){var t=arguments[1],n=this;setTimeout(function(){t(n)},0)}return this},jQuery.fn.roundabout_adjustTilt=function(e){if(e=jQuery.roundabout_toFloat(e),0!==e&&this.each(function(){jQuery(this).data("roundabout").tilt=jQuery.roundabout_toFloat(jQuery(this).roundabout_get("tilt")+e),jQuery(this).roundabout_updateChildPositions()}),"function"==typeof arguments[1]){var t=arguments[1],n=this;setTimeout(function(){t(n)},0)}return this},jQuery.fn.roundabout_animateToBearing=function(e){e=jQuery.roundabout_toFloat(e);var t=new Date,n=arguments[1]===void 0?null:arguments[1],i=arguments[2]===void 0?null:arguments[2],o="object"!=typeof arguments[3]?null:arguments[3];return this.each(function(){var a,r,s,l=jQuery(this),c=l.data("roundabout"),d=null===n?c.duration:n,u=null!==i?i:c.easing||"swing";null===o&&(o={timerStart:t,start:jQuery.roundabout_getBearing(l),totalTime:d}),a=t-o.timerStart,d>a?(c.animating=1,"string"==typeof jQuery.easing.def?(r=jQuery.easing[u]||jQuery.easing[jQuery.easing.def],s=r(null,a,o.start,e-o.start,o.totalTime)):s=jQuery.easing[u](a/o.totalTime,a,o.start,e-o.start,o.totalTime),l.roundabout_setBearing(s,function(){l.roundabout_animateToBearing(e,d,u,o)})):(e=0>e?e+360:e%360,c.animating=0,l.roundabout_setBearing(e))}),this},jQuery.fn.roundabout_animateToDelta=function(e){var t=arguments[1],n=arguments[2];return this.each(function(){e=jQuery.roundabout_getBearing(jQuery(this))+jQuery.roundabout_toFloat(e),jQuery(this).roundabout_animateToBearing(e,t,n)}),this},jQuery.fn.roundabout_animateToChild=function(e){var t=arguments[1],n=arguments[2];return this.each(function(){var i=jQuery(this),o=i.data("roundabout");if(o.childInFocus!==e&&0===o.animating){var a=jQuery(i.children(o.childSelector)[e]);i.roundabout_animateAngleToFocus(a.data("roundabout").degrees,t,n)}}),this},jQuery.fn.roundabout_animateToNearbyChild=function(e,t){var n=e[0],i=e[1];return this.each(function(){var e,o=jQuery(this).data("roundabout"),a=jQuery.roundabout_toFloat(360-jQuery.roundabout_getBearing(jQuery(this))),r=o.period,s=0,l=o.reflect,c=jQuery(this).children(o.childSelector).length;if(a=l===!0?a%360:a,0===o.animating)if(l===!1&&"next"===t||l===!0&&"next"!==t)for(a=0===a?360:a;c>s;){if(e={lower:jQuery.roundabout_toFloat(r*s),upper:jQuery.roundabout_toFloat(r*(s+1))},e.upper=s==c-1?360:e.upper,e.upper>=a&&a>e.lower){jQuery(this).roundabout_animateToDelta(a-e.lower,n,i);break}s++}else for(;;){if(e={lower:jQuery.roundabout_toFloat(r*s),upper:jQuery.roundabout_toFloat(r*(s+1))},e.upper=s==c-1?360:e.upper,a>=e.lower&&e.upper>a){jQuery(this).roundabout_animateToDelta(a-e.upper,n,i);break}s++}}),this},jQuery.fn.roundabout_animateToNextChild=function(){return this.roundabout_animateToNearbyChild(arguments,"next")},jQuery.fn.roundabout_animateToPreviousChild=function(){return this.roundabout_animateToNearbyChild(arguments,"previous")},jQuery.fn.roundabout_animateAngleToFocus=function(e){var t=arguments[1],n=arguments[2];return this.each(function(){var i=jQuery.roundabout_getBearing(jQuery(this))-e;i=Math.abs(360-i)<Math.abs(0-i)?360-i:0-i,i=i>180?-(360-i):i,0!==i&&jQuery(this).roundabout_animateToDelta(i,t,n)}),this},jQuery.fn.roundabout_updateChildPositions=function(){return this.each(function(){var e=jQuery(this),t=e.data("roundabout"),n=-1,i={bearing:jQuery.roundabout_getBearing(e),tilt:t.tilt,stage:{width:Math.floor(.9*e.width()),height:Math.floor(.9*e.height())},animating:t.animating,inFocus:t.childInFocus,focusBearingRad:jQuery.roundabout_degToRad(t.focusBearing),shape:jQuery.roundabout_shape[t.shape]||jQuery.roundabout_shape[jQuery.roundabout_shape.def]};i.midStage={width:i.stage.width/2,height:i.stage.height/2},i.nudge={width:i.midStage.width+.05*i.stage.width,height:i.midStage.height+.05*i.stage.height},i.zValues={min:t.minZ,max:t.maxZ,diff:t.maxZ-t.minZ},i.scale={min:t.minScale,max:t.maxScale,diff:t.maxScale-t.minScale},e.children(t.childSelector).each(function(t){jQuery.roundabout_updateChildPosition(jQuery(this),e,i,t)&&0===i.animating?(n=t,jQuery(this).addClass("roundabout-in-focus")):jQuery(this).removeClass("roundabout-in-focus")}),n!==i.inFocus&&(jQuery.roundabout_triggerEvent(e,i.inFocus,"blur"),-1!==n&&jQuery.roundabout_triggerEvent(e,n,"focus"),t.childInFocus=n)}),this},jQuery.roundabout_getBearing=function(e){return jQuery.roundabout_toFloat(e.data("roundabout").bearing)%360},jQuery.roundabout_degToRad=function(e){return e%360*Math.PI/180},jQuery.roundabout_isInFocus=function(e,t){return jQuery.roundabout_getBearing(e)%360===t%360},jQuery.roundabout_triggerEvent=function(e,t,n){return 0>t?this:jQuery(e.children(e.data("roundabout").childSelector)[t]).trigger(n)},jQuery.roundabout_toFloat=function(e){return e=Math.round(1e3*parseFloat(e))/1e3,parseFloat(e.toFixed(2))},jQuery.roundabout_updateChildPosition=function(e,t,n,i){for(var o=jQuery(e),a=o.data("roundabout"),r=[],s=jQuery.roundabout_degToRad(360-o.data("roundabout").degrees+n.bearing);0>s;)s+=2*Math.PI;for(;s>2*Math.PI;)s-=2*Math.PI;var l=n.shape(s,n.focusBearingRad,n.tilt);return l.scale=l.scale>1?1:l.scale,l.adjustedScale=((n.scale.min+n.scale.diff*l.scale)*(n.scale.min+n.scale.diff*l.scale)*(n.scale.min+n.scale.diff*l.scale)).toFixed(4),l.width=(l.adjustedScale*a.startWidth).toFixed(4),l.height=(l.adjustedScale*a.startHeight).toFixed(4),o.css("left",(l.x*n.midStage.width+n.nudge.width-l.width/2).toFixed(1)+"px").css("top",(l.y*n.midStage.height+n.nudge.height-l.height/2).toFixed(1)+"px").css("width",l.width+"px").css("height",l.height+"px").css("z-index",Math.round(n.zValues.min+n.zValues.diff*l.z)).css("font-size",(l.adjustedScale*a.startFontSize).toFixed(2)+"px").attr("current-scale",l.adjustedScale),t.data("roundabout").debug===!0&&(r.push('<div style="font-weight: normal; font-size: 10px; padding: 2px; width: '+o.css("width")+'; background-color: #ffc;">'),r.push('<strong style="font-size: 12px; white-space: nowrap;">Child '+i+"</strong><br />"),r.push("<strong>left:</strong> "+o.css("left")+"<br /><strong>top:</strong> "+o.css("top")+"<br />"),r.push("<strong>width:</strong> "+o.css("width")+"<br /><strong></strong> "+"<br />"),r.push("<strong>z-index:</strong> "+o.css("z-index")+"<br /><strong>font-size:</strong> "+o.css("font-size")+"<br />"),r.push("<strong>scale:</strong> "+o.attr("current-scale")),r.push("</div>"),o.html(r.join(""))),jQuery.roundabout_isInFocus(t,o.data("roundabout").degrees)};
